{% extends 'base_dashboard.html' %}  {# Extends the dashboard base template #}

{% block title %}Monthly Report | Gastadorcheck{% endblock %} {# Sets the page title #}

{% block extra_css %}
    {# Links to additional CSS files #}
    <link rel="stylesheet" href="/static/css/landing.css"> {# Custom CSS for background #}
    {# Add any report-specific CSS if needed #}
{% endblock %}

{% block body_classes %}home-page{% endblock %} {# Applies a body class for styling #}

{% block header %}{% endblock %} {# Overrides and removes the header block #}

{% block content %}
    {# Main content container with background and blur effects #}
    <div class="bg-white bg-opacity-40 backdrop-filter backdrop-blur-lg rounded-lg shadow p-6 my-8">

        {# Content specific to the monthly report page #}
        <div class="mb-6 flex justify-between items-center">
            <div>
                <h2 class="text-3xl font-bold text-gray-800">Monthly Report</h2>
                <p class="text-gray-600">{{ start_date|date:"F Y" }}</p>
            </div>
            <div>
                <a href="{% url 'report_dashboard' %}" class="text-indigo-600 hover:text-indigo-800">
                    ‚Üê Back to Reports
                </a>
            </div>
        </div>

        {% if not has_any_transactions %}
            <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 text-center">
                <div class="text-amber-500 text-4xl mb-4">üìä</div>
                <h3 class="text-xl font-semibold text-amber-700 mb-2">No transactions yet!</h3>
                <p class="text-amber-600 mb-4">Start adding income and expenses to see your monthly reports.</p>
                <div class="flex justify-center space-x-2">
                    <a href="{% url 'transaction_add' %}?type=INCOME" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition">
                        Add Income
                    </a>
                    <a href="{% url 'transaction_add' %}?type=EXPENSE" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                        Add Expense
                    </a>
                </div>
            </div>
        {% else %}
            <div class="bg-white p-4 mb-6 rounded-lg shadow-md">
                <form method="get" class="flex flex-wrap items-center gap-3">
                    <div class="flex-grow">
                        <label for="month_selector" class="block text-sm font-medium text-gray-700 mb-1">Select Month</label>
                        <select id="month_selector" name="month_year" onchange="this.form.submit()" class="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                            {% if month_options %}
                                {% for option in month_options %}
                                    <option value="{{ option.month }},{{ option.year }}" {% if option.selected %}selected{% endif %}>
                                        {{ option.name }}
                                    </option>
                                {% endfor %}
                            {% else %}
                                <option value="{{ month }},{{ year }}">{{ start_date|date:"F Y" }}</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <a href="{% url 'export_data' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}"
                           class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm transition flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            Export This Month
                        </a>
                    </div>
                </form>
            </div>

            {% if transactions %}
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-sm text-gray-500">Income</p>
                        <p class="text-2xl font-bold text-green-600">${{ income_total }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-sm text-gray-500">Expenses</p>
                        <p class="text-2xl font-bold text-red-600">${{ expense_total }}</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="text-sm text-gray-500">Balance</p>
                        <p class="text-2xl font-bold {% if balance >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                            ${{ balance }}
                        </p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Income by Category</h3>

                        {% if income_by_category %}
                            <div id="income-chart" class="h-64"></div>

                            <div class="mt-4 space-y-2">
                                {% for category in income_by_category %}
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ category.category__color|default:'#10B981' }}"></span>
                                            <span>{{ category.category__name|default:"Uncategorized" }}</span>
                                        </div>
                                        <span class="font-semibold">${{ category.total }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="flex flex-col items-center justify-center h-64 bg-gray-50 rounded p-4">
                                <div class="text-green-400 text-4xl mb-2">üíµ</div>
                                <p class="text-gray-500 italic text-center">No income transactions in this period.</p>
                                <a href="{% url 'transaction_add' %}?type=INCOME" class="mt-3 text-green-600 hover:text-green-800 text-sm flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Income
                                </a>
                            </div>
                        {% endif %}
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Expenses by Category</h3>

                        {% if expense_by_category %}
                            <div id="expense-chart" class="h-64"></div>

                            <div class="mt-4 space-y-2">
                                {% for category in expense_by_category %}
                                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                        <div class="flex items-center">
                                            <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ category.category__color|default:'#EF4444' }}"></span>
                                            <span>{{ category.category__name|default:"Uncategorized" }}</span>
                                        </div>
                                        <span class="font-semibold">${{ category.total }}</span>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="flex flex-col items-center justify-center h-64 bg-gray-50 rounded p-4">
                                <div class="text-red-400 text-4xl mb-2">üí≥</div>
                                <p class="text-gray-500 italic text-center">No expense transactions in this period.</p>
                                <a href="{% url 'transaction_add' %}?type=EXPENSE" class="mt-3 text-red-600 hover:text-red-800 text-sm flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                                    </svg>
                                    Add Expense
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">Transactions</h3>
                        {% if transactions.count > 0 %}
                            <span class="text-sm text-gray-500">Showing {{ transactions.count }} transaction(s)</span>
                        {% endif %}
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-4 text-left">Date</th>
                                    <th class="py-2 px-4 text-left">Title</th>
                                    <th class="py-2 px-4 text-left">Category</th>
                                    <th class="py-2 px-4 text-left">Type</th>
                                    <th class="py-2 px-4 text-right">Amount</th>
                                    <th class="py-2 px-4 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                {% for transaction in transactions %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-2 px-4">{{ transaction.date }}</td>
                                        <td class="py-2 px-4">{{ transaction.title }}</td>
                                        <td class="py-2 px-4">
                                            {% if transaction.category %}
                                                <div class="flex items-center">
                                                    <span class="w-3 h-3 rounded-full mr-2" style="background-color: {{ transaction.category.color }}"></span>
                                                    {{ transaction.category.name }}
                                                </div>
                                            {% else %}
                                                Uncategorized
                                            {% endif %}
                                        </td>
                                        <td class="py-2 px-4">{{ transaction.get_type_display }}</td>
                                        <td class="py-2 px-4 text-right {% if transaction.type == 'INCOME' %}text-green-600{% else %}text-red-600{% endif %}">
                                            ${{ transaction.amount }}
                                        </td>
                                        <td class="py-2 px-4 text-center">
                                            <div class="flex justify-center space-x-2">
                                                <a href="{% url 'transaction_edit' transaction.id %}" class="text-indigo-600 hover:text-indigo-800 text-sm">
                                                    Edit
                                                </a>
                                                <a href="{% url 'transaction_delete' transaction.id %}" class="text-red-600 hover:text-red-800 text-sm">
                                                    Delete
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <div class="bg-white p-6 rounded-lg shadow-md text-center">
                    <div class="py-10">
                        <div class="text-gray-400 text-5xl mb-4">üìÖ</div>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">No transactions for {{ start_date|date:"F Y" }}</h3>
                        <p class="text-gray-500 mb-6">There are no transactions recorded for this period.</p>

                        <div class="flex justify-center space-x-3">
                            <a href="{% url 'transaction_add' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition">
                                Add Transaction
                            </a>

                            {% if month_options and month_options|length > 1 %}
                                <div class="relative" x-data="{ open: false }">
                                    <button @click="open = !open" class="bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded transition flex items-center">
                                        Try Another Month
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>

                                    <div class="absolute mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10"
                                         x-show="open"
                                         @click.away="open = false">
                                        <div class="py-1" role="menu" aria-orientation="vertical">
                                            {% for option in month_options %}
                                                {% if not option.selected %}
                                                    <a href="?month={{ option.month }}&year={{ option.year }}"
                                                       class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900"
                                                       role="menuitem">
                                                        {{ option.name }}
                                                    </a>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}

    </div> {# End main content container #}
{% endblock %}

{% block extra_js %}
{# Includes additional JavaScript files or scripts #}
{# Script for ApexCharts rendering #}
{% if income_by_category or expense_by_category %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% if income_by_category %}
        // Create income chart
        const incomeLabels = [
            {% for category in income_by_category %}
                "{{ category.category__name|default:'Uncategorized' }}",
            {% endfor %}
        ];

        const incomeValues = [
            {% for category in income_by_category %}
                {{ category.total }},
            {% endfor %}
        ];

        const incomeColors = [
            {% for category in income_by_category %}
                "{{ category.category__color|default:'#10B981' }}",
            {% endfor %}
        ];

        const incomeOptions = {
            series: incomeValues,
            chart: {
                type: 'pie',
                height: 250
            },
            labels: incomeLabels,
            colors: incomeColors,
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: 200
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }],
            tooltip: {
                y: {
                    formatter: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        };

        const incomeChart = new ApexCharts(document.querySelector("#income-chart"), incomeOptions);
        incomeChart.render();
        {% endif %}

        {% if expense_by_category %}
        // Create expense chart
        const expenseLabels = [
            {% for category in expense_by_category %}
                "{{ category.category__name|default:'Uncategorized' }}",
            {% endfor %}
        ];

        const expenseValues = [
            {% for category in expense_by_category %}
                {{ category.total }},
            {% endfor %}
        ];

        const expenseColors = [
            {% for category in expense_by_category %}
                "{{ category.category__color|default:'#EF4444' }}",
            {% endfor %}
        ];

        const expenseOptions = {
            series: expenseValues,
            chart: {
                type: 'pie',
                height: 250
            },
            labels: expenseLabels,
            colors: expenseColors,
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: 200
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }],
            tooltip: {
                y: {
                    formatter: function(value) {
                        return '$' + value.toFixed(2);
                    }
                }
            }
        };

        const expenseChart = new ApexCharts(document.querySelector("#expense-chart"), expenseOptions);
        expenseChart.render();
        {% endif %}
    });
</script>
{% endif %}
{% endblock %}

{% block footer %}
    {# Custom footer block #}
    <footer class="home-footer">
        <p>&copy; {% now "Y" %} GastadorCheck Budget Tracker. All rights reserved.</p>
    </footer>
{% endblock %}